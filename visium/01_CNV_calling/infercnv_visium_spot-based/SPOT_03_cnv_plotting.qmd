---
title: "20250729_spot_based_cnv_plotting"
author: "Tatjana Tomek"
format: html
editor: visual
---

## Spot-based CNV calling -plots

to plot the cnvs that were uncovered per visium spot as opposed to per spatial domain.

```{r}
# load libraries
library(qs)
library(gtrellis)
library(circlize)
library(GenomicRanges)
library(EnrichedHeatmap)
library(tidyverse)
library(ComplexHeatmap)
```

```{r}
# load data
cnvs = read.csv("/g/saka/Tatjana/data/data_for_testing_stuff/20250912_spotbased_cnv_calling_script5_LN0040HD_12BV2R_R1_extracted_from_mcmc_obj.csv")
#cnvs[cnvs == 1 | cnvs == 2] = "del"
#cnvs[cnvs == 4 | cnvs == 5 | cnvs == 6] = "amp"

```

```{r}
# problem with above solution: due to "reduce" function in preprocessing script (05_version2), 
# not all cnvs have singular integer value reported for their "state":
# e.g. when looking at 
#unique(as.vector(as.matrix(cnvs[, 7:ncol(cnvs)])))
#[1] " 2"  NA    " 4"  " 5"  "2"   "4"   "4,5" "5"   "5,4" " 1"  "2,2" "2,1" "1" 

# need to revisit preprocessing script and amend -> workaround for now, to get plotting to work:
cnvs[cnvs == 1 | cnvs == 2 | cnvs == "2,2" | cnvs == "2,1"] = "del" # "deletion" states
cnvs[cnvs == 4 | cnvs == 5 | cnvs == 6 | cnvs == "4,5" | cnvs == "5,4"] = "amp" #"amplification" states
cnvs[is.na(cnvs)] = "NA" # convert NA values to string as otherwise "normalize_genomic_signals_to_bins()" function gives an error -> look into later

# now:
 unique(as.vector(as.matrix(cnvs[, 7:ncol(cnvs)])))
# [1] "del" NA    "amp"

## TODO: fix this in prepro script
```

```{r}
# the "normalize_genomic_signals_to_bins" function does not work with a full character matrix, need to supply the cols individually (at least according to their vignette examples)
# therefore split our cnv matrix into sublists. Keep the first 6 cols in every sublist
base_cols = cnvs[, 1:6]

# get all the patient columns
LN_cols = grep("LN0040HD", names(cnvs), value = TRUE)

LN_sublists = map(LN_cols, function(col_name) {
  cbind(base_cols, cnvs[[col_name]]) %>%
    setNames(c(names(base_cols), col_name))  
})
```

Using package described in this blogpost: <https://jokergoo.github.io/2020/10/29/make-genome-scale-heatmap/>

```{r}
binnedgenome = bin_genome("hg38", bin_size = 10000)
binnedgenome
```

```{r}
char_mat = NULL
fin = length(LN_sublists)
for (i in 1:fin) {
  bed = LN_sublists[[i]]
  gr_bed = GRanges(seqnames = bed[, 1], 
                      ranges = IRanges(
                        bed[,2], 
                        bed[,3]))
  char_mat = cbind(
    char_mat, 
    normalize_genomic_signals_to_bins(
      gr_bed, 
      bed[, 7],
      empty_value = NA))
}
```

```{r}
saveRDS(char_mat, "/g/saka/Tatjana/data/data_for_testing_stuff/0X_spot_based_cnv_plotting/LN0040HD_12BV2R_R1_cnv_char_mat_for_complexheatmap.rds")
```

```{r}
# transpose so rows = Visium spots
char_mat_t = t(char_mat)
#charmat_t = t(charmat)

# extract chromosome from colnames of char mat, get unique chroms
chroms = sub(":.*", "", colnames(char_mat_t))
chroms_u = unique(chroms)

# get bin start pos from colnames
starts = as.numeric(sub(".*:([0-9]+)-([0-9]+)", "\\1", colnames(char_mat_t)))

# make granges for bins (for creating ideogram)
gr = GRanges(seqnames = chroms,
              ranges = IRanges(start = starts, 
                               end = starts + 9999))  # assuming 10kb bins

# set cnv colors
cnv_colors = c("amp" = "red", "del" = "blue", "NA" = "white") # very sloppy, NA vals should be NA and not string NA - quick workaround, fix later

# make annot for idogram: each chrom gets bar which spans its bins
ideo_anno = HeatmapAnnotation(
  ideogram = anno_barplot(
    rep(1, ncol(char_mat_t)),   
    gp = gpar(fill = "#BEBEBE", col = NA),
    border = TRUE,
    axis = FALSE,
    annotation_name = NULL,
    column_title_gp = gpar(fontsize = 8)
  ),
  annotation_name = NULL,
  height = unit(0.5, "cm")
)

png("/g/saka/Tatjana/data/data_for_testing_stuff/CNV_heatmap_test.png", width = 8000, height = 1000, res = 300) 


# now, make heatmap with column split to get individual "boxes" for chromosomes
htmp = Heatmap(
  char_mat_t,
  name = "CNV",
  col = cnv_colors,
  na_col = "white", ##
  border = TRUE,
  row_title = "Visium spots",
  cluster_rows = FALSE,
  cluster_columns = FALSE,
  show_column_names = FALSE,
  column_split = chroms,
  column_title = chroms_u,
  bottom_annotation = ideo_anno,
  # width = rep(unit(1, "cm"), length(chroms_u)) # heatmap not being plotted when I do this, look for it later
)

draw(htmp, heatmap_legend_side = "bottom")

dev.off()
```
