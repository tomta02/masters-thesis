---
title: "20250702_pathway_analysis_progeny"
author: "Tatjana Tomek"
format: html
editor: visual
---

## Pathway analysis on Visium data using PROGENy + decoupleR

investigating biological pathway enrichment in patient Visium datasets

```{r}
# load libraries
library(Seurat)
library(qs)
library(Matrix)
library(hdf5r)
library(decoupleR)
library(dplyr)
library(tibble)
library(tidyr)
library(patchwork)
library(ggplot2)
library(pheatmap)
library(gridExtra)
library(funkyheatmap)
```

```{r}
# loading Visium data
visiumlist = qread("/g/saka/Kristy/projects/composite/analysis/rdata/02_10_visium_flt.qs", nthreads = 32)
```

```{r}
# load progeny: pathways, target genes and weights
pr = get_progeny(organism = 'human', top = 100)
```

Now, to infer pathway scores, need the info stored in progeny and apply it to our patient data applying a statistical model -\> use multivariate linear model (like in vignette), but there are others available too

```{r}
# first, extract sct-transformed count matrices. Maybe run on log norm. count matrices later
sct_list = lapply(visiumlist, function(seu) {
  sctmat = as.matrix(seu@assays$SCT$data)
})
rm(visiumlist)
gc()
```

```{r}
# concatenate individual ROI-matrices per patient. 22 count matrices -> 6 count matrices
pat_ids = sub("_.*", "", names(sct_list)) %>% unique()

master_list = list()
for (id in pat_ids) {
  s_indices = grep(id, names(sct_list))
  samples = sct_list[s_indices]
  concat = do.call(cbind, samples) 
  master_list[[id]] = concat
}
```

```{r}
# run linear model on all pat
pw_lst = lapply(master_list, function(pat) {
  acts = run_mlm(mat = pat,
                 net = pr,
                 .source = "source",
                 .target = "target",
                 .mor = "weight",
                 minsize = 5)
})
```

Plotting

```{r}
# first, modify data into a long dataframe for plotting - exctract pathway activities
act_lst = lapply(pw_lst, function(df) {
  df %>% pivot_wider(
    id_cols = 'condition',
    names_from = 'source',
    values_from = 'score') %>%
    tibble::column_to_rownames(var = 'condition')
})
```

```{r}
# further, extract p values associated w pathway activities per visium spot
pv_list = lapply(pw_lst, function(df) {
  df %>% pivot_wider(
    id_cols = 'condition',
    names_from = 'source',
    values_from = 'p_value') %>%
    tibble::column_to_rownames(var = 'condition')
})
```

```{r}
# generate all pheatmaps plots into a list
plots = mapply(function(mat, nm) {
  pheatmap(
    mat, 
    show_rownames = FALSE, 
    silent = TRUE,
    cluster_cols = FALSE,
    main = nm)
}, act_lst, names(act_lst), SIMPLIFY = FALSE)

# open png 
png("/g/saka/Tatjana/data/data_for_testing_stuff/progeny_top100_genes/progeny_act_grid_top100.png", width = 4500, height = 3000, res = 300) 

# to save them together: arrange in grid
grid.arrange(grobs = lapply(plots, function(p) p$gtable), ncol = 3)
dev.off()
```

```{r}
for (idx in (seq_along(plots))) {
  htmp = plots[[idx]]
  
  # open png
  png(paste0("/g/saka/Tatjana/data/data_for_testing_stuff/progeny_top100_genes/heatmap_acts_s", idx, ".png"), 
      width = 1500, 
      height = 2000, 
      res = 300)
  
  print(htmp)
  
  dev.off()
}
```

```{r}
# now make same plots for pvals:
# generate all pval plots into a list
plots_pv = mapply(function(mat, nm) {
  pheatmap(
    mat, 
    color = c("red", "blue"),
    breaks = c(0, 0.05, 1),
    legend_breaks = c(0, 0.05, 0.2, 0.4, 0,6, 0.8),
    main = nm,
    show_rownames = FALSE, 
    silent = TRUE,
    cluster_cols = FALSE)
}, pv_list, names(pv_list), SIMPLIFY = FALSE)

# open png 
png("/g/saka/Tatjana/data/data_for_testing_stuff/progeny_top100_genes/progeny_pv_grid_top100.png", width = 4500, height = 3000, res = 300) 

# to save them together: arrange in grid
grid.arrange(grobs = lapply(plots_pv, function(p) p$gtable), ncol = 3)
dev.off()

```

Problem with this analysis: we need to plot one more property, which is p value (statistical significance of pathway being called), not possible with pheatmap (-\> check out other heatmap tools, mayb complexheatmap?) \

1.  pvals per pw per spot often very high -\> try again running on bayesspace subclustered spots, perhaps pathway activity calling improves?
2.  do morans I analysis to get spatial differential pathway activity
