---
title: "20250702_pathway_analysis_progeny"
author: "Tatjana Tomek"
format: html
editor: visual
---

## Pathway analysis on Visium data using PROGENy + decoupleR

investigating biological pathway enrichment in patient Visium datasets

```{r}
# load libraries
library(Seurat)
library(qs)
library(Matrix)
library(hdf5r)
library(decoupleR)
library(tidyverse)
library(patchwork)
library(ggplot2)
library(pheatmap)
library(gridExtra)
library(funkyheatmap)
```

## 1. Pathway inference

```{r}
# loading Visium data
visiumlist = qread("/g/saka/Kristy/projects/composite/analysis/rdata/02_13_visium_flt.qs", nthreads = 32)
```

```{r}
# load progeny: pathways, target genes and weights
pr = get_progeny(organism = 'human', top = 500)

# sum(pr$weight == 0) checking whether beta coefficients of progeny model have been set to 0 for any of the genes (in paper, they only kept coeff of top 100 scoring genes). But is not the case
```

```{r}
# first, extract sct-transformed count matrices. Maybe run on log norm. count matrices later. Also extract spatial domain annotations
sct_list = map(visiumlist, ~ as.matrix(.x@assays$SCT$data))
annot_list = map(visiumlist, ~ as.matrix(.x@meta.data$prelim_growth_2))

```

```{r}
# get patient ids
pat_ids = sub("_.*", "", names(sct_list)) %>% unique()
```

```{r}
# concatenate individual ROI-matrices per patient. 22 count matrices -> 6 count matrices (1 per patient)
pat_masterlist = map(pat_ids, ~ do.call(cbind, sct_list[grep(.x, names(sct_list))])) %>%
  set_names(pat_ids)

# also concatenate spatial domains per patient
master_annot = map(pat_ids, ~ do.call(rbind, annot_list[grep(.x, names(annot_list))])) %>%
  set_names(pat_ids)

# rm visiumlist to not run out of space
rm(visiumlist)
gc()
```

```{r}
# run linear model on all patients - infer pathway activities from gene expression information using pw x gene interaction weights stored in PROGENy
pw_list = lapply(pat_masterlist, function(pat) {
  acts = run_mlm(mat = pat,
                 net = pr,
                 .source = "source",
                 .target = "target",
                 .mor = "weight",
                 minsize = 5)
})
```

## 2. Plotting

### 2.1 ) data wrangling to plot heatmap of pathway activities

```{r}
# make helper funktion
makewidefrompw = function(df, value_col) {
  df %>% pivot_wider(
    id_cols = 'condition',
    names_from = 'source',
    values_from = {{value_col}}
    ) %>% 
    tibble::column_to_rownames(var = 'condition')
}
```

```{r}
# use it to exctract pathway activities and p values from pw_list
act_list = map(pw_list, makewidefrompw, value_col = score)
pval_list = map(pw_list, makewidefrompw, value_col = p_value)
```

```{r}
# add spatial domain identities as column to act_lst, and order rows
act_list = map2(act_list, master_annot, ~ {
  .x$spatial_domain <- .y
  .x[order(.x$spatial_domain), ]
})
```

```{r}
# also filter act_list based on pval: only keep activity values for each barcode and each pw where the pval < 0.05
act_list_flt = lapply(seq_along(act_list), function(i) {
  df = act_list[[i]]
  pvals = pval_list[[i]]
  
  df[, 1:ncol(pvals)][pvals >= 0.05] <- NA
  df
})
names(act_list_flt) = names(act_list)
```

### 2.2. plot heatmaps

```{r}
# select colors for heatmap plots
# mb ask Kristy for her color scheme, looks very nice

anncolors = list(
  spatial_domain = c(
    diffuse_fdc.hi = "#0072B2",
    diffuse_fdc.lo = "#009E73",
    follicular_fdc.hi = "#CC79A7",
    follicular_fdc.lo = "#F0E442",
    interfollicular_malig.hi = "#D55E00",
    interfollicular_malig.lo = "#E69F00",
    other = "#A6761D"
  )
)
```

```{r}
## CONTINUE HERE

# generate all pheatmaps plots into a list
plots = mapply(function(mat, nm) {
  
  ann_row = data.frame(mat$spatial_domain)
  rownames(ann_row) = rownames(mat)
  colnames(ann_row) = "spatial_domain"
  
  # drop annotation colum
  mat_num = as.matrix(mat[ , !(colnames(mat) %in% "spatial_domain")])
  mat

  pheatmap(
    mat_num, 
    show_rownames = FALSE, 
    annotation_row = ann_row,
    annotation_colors = anncolors,
    silent = TRUE,
    cluster_cols = FALSE,
    cluster_rows = FALSE,
    na_col = "grey",
    #clustering_method = "ward.D2", #### rm
    main = nm)
}, act_list_flt, names(act_list_flt), SIMPLIFY = FALSE)


# save all plots
# open png 
png("/g/saka/Tatjana/data/data_for_testing_stuff/progeny_top500_genes/run_on_sctransformed_mat/progeny_act_grid_top500_w_spat_dom_pval<0.05.png", width = 4500, height = 3000, res = 300) 

# to save them together: arrange in grid
grid.arrange(grobs = lapply(plots, function(p) p$gtable), ncol = 3)
dev.off()
```

```{r}
# save individual heatmaps
for (idx in (seq_along(plots))) {
  htmp = plots[[idx]]
  
  # open png
  png(paste0("/g/saka/Tatjana/data/data_for_testing_stuff/progeny_top500_genes/run_on_sctransformed_mat/heatmap_acts_s_pval<0.05", idx, ".png"), 
      width = 1500, 
      height = 2000, 
      res = 300)
  
  print(htmp)
  
  dev.off()
}
```

```{r}
# now make same plots for pvals:
# generate all pval plots into a list
plots_pv = mapply(function(mat, nm) {
  pheatmap(
    mat, 
    color = c("red", "blue"),
    breaks = c(0, 0.05, 1),
    legend_breaks = c(0, 0.05, 1),
    main = nm,
    show_rownames = FALSE, 
    silent = TRUE,
    cluster_cols = FALSE)
}, pval_list, names(pval_list), SIMPLIFY = FALSE)

# open png 
png("/g/saka/Tatjana/data/data_for_testing_stuff/progeny_top500_genes/run_on_sctransformed_mat/progeny_pv_grid_top500.png", width = 4500, height = 3000, res = 300) 

# to save them together: arrange in grid
grid.arrange(grobs = lapply(plots_pv, function(p) p$gtable), ncol = 3)
dev.off()

```

Problem with this analysis: we need to plot one more property, which is p value (statistical significance of pathway being called), not possible with pheatmap (-\> check out other heatmap tools, mayb complexheatmap?)\

1.  pvals per pw per spot often very high -\> try again running on bayesspace subclustered spots, perhaps pathway activity calling improves?

    -\> for now now, aim to finish analysis of full visium spots first

2.  do morans I analysis to get spatial differential pathway activity -\> extract spot coordinates w Seurat GetTissueCoordinates

3.  TODO violin plots: 1 plot for each sample, 14 subplots for each pathway; each pw has nr. of violins = nr. of spatial domains -\> plot differential pw activity per spatial domain

4.  code very redundant, simplify!!!

5.  make 2 scripts out of this -\> one for running decoupleR, separate one(s) for plotting

6.  color scheme for spatial domain annotations not consistent!! Amend

```{r}
# make violin  plots for each sample
# start out trying with one singular patient
```
